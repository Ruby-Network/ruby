!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).BareMod={})}(this,(function(e){"use strict";const t=globalThis.fetch,s=globalThis.WebSocket,n={prototype:{send:s.prototype.send},CLOSED:s.CLOSED,CLOSING:s.CLOSING,CONNECTING:s.CONNECTING,OPEN:s.OPEN};class r extends Error{status;body;constructor(e,t){super(t.message||t.code),this.status=e,this.body=t}}class o{base;constructor(e,t){this.base=new URL(`./v${e}/`,t)}}function a(e,t){const s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function c(e,t,s,n,r,o){return a((c=a(a(t,e),a(n,o)))<<(i=r)|c>>>32-i,s);var c,i}function i(e,t,s,n,r,o,a){return c(t&s|~t&n,e,t,r,o,a)}function d(e,t,s,n,r,o,a){return c(t&n|s&~n,e,t,r,o,a)}function u(e,t,s,n,r,o,a){return c(t^s^n,e,t,r,o,a)}function h(e,t,s,n,r,o,a){return c(s^(t|~n),e,t,r,o,a)}function f(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;let s=1732584193,n=-271733879,r=-1732584194,o=271733878;for(let t=0;t<e.length;t+=16){const c=s,f=n,l=r,p=o;s=i(s,n,r,o,e[t],7,-680876936),o=i(o,s,n,r,e[t+1],12,-389564586),r=i(r,o,s,n,e[t+2],17,606105819),n=i(n,r,o,s,e[t+3],22,-1044525330),s=i(s,n,r,o,e[t+4],7,-176418897),o=i(o,s,n,r,e[t+5],12,1200080426),r=i(r,o,s,n,e[t+6],17,-1473231341),n=i(n,r,o,s,e[t+7],22,-45705983),s=i(s,n,r,o,e[t+8],7,1770035416),o=i(o,s,n,r,e[t+9],12,-1958414417),r=i(r,o,s,n,e[t+10],17,-42063),n=i(n,r,o,s,e[t+11],22,-1990404162),s=i(s,n,r,o,e[t+12],7,1804603682),o=i(o,s,n,r,e[t+13],12,-40341101),r=i(r,o,s,n,e[t+14],17,-1502002290),n=i(n,r,o,s,e[t+15],22,1236535329),s=d(s,n,r,o,e[t+1],5,-165796510),o=d(o,s,n,r,e[t+6],9,-1069501632),r=d(r,o,s,n,e[t+11],14,643717713),n=d(n,r,o,s,e[t],20,-373897302),s=d(s,n,r,o,e[t+5],5,-701558691),o=d(o,s,n,r,e[t+10],9,38016083),r=d(r,o,s,n,e[t+15],14,-660478335),n=d(n,r,o,s,e[t+4],20,-405537848),s=d(s,n,r,o,e[t+9],5,568446438),o=d(o,s,n,r,e[t+14],9,-1019803690),r=d(r,o,s,n,e[t+3],14,-187363961),n=d(n,r,o,s,e[t+8],20,1163531501),s=d(s,n,r,o,e[t+13],5,-1444681467),o=d(o,s,n,r,e[t+2],9,-51403784),r=d(r,o,s,n,e[t+7],14,1735328473),n=d(n,r,o,s,e[t+12],20,-1926607734),s=u(s,n,r,o,e[t+5],4,-378558),o=u(o,s,n,r,e[t+8],11,-2022574463),r=u(r,o,s,n,e[t+11],16,1839030562),n=u(n,r,o,s,e[t+14],23,-35309556),s=u(s,n,r,o,e[t+1],4,-1530992060),o=u(o,s,n,r,e[t+4],11,1272893353),r=u(r,o,s,n,e[t+7],16,-155497632),n=u(n,r,o,s,e[t+10],23,-1094730640),s=u(s,n,r,o,e[t+13],4,681279174),o=u(o,s,n,r,e[t],11,-358537222),r=u(r,o,s,n,e[t+3],16,-722521979),n=u(n,r,o,s,e[t+6],23,76029189),s=u(s,n,r,o,e[t+9],4,-640364487),o=u(o,s,n,r,e[t+12],11,-421815835),r=u(r,o,s,n,e[t+15],16,530742520),n=u(n,r,o,s,e[t+2],23,-995338651),s=h(s,n,r,o,e[t],6,-198630844),o=h(o,s,n,r,e[t+7],10,1126891415),r=h(r,o,s,n,e[t+14],15,-1416354905),n=h(n,r,o,s,e[t+5],21,-57434055),s=h(s,n,r,o,e[t+12],6,1700485571),o=h(o,s,n,r,e[t+3],10,-1894986606),r=h(r,o,s,n,e[t+10],15,-1051523),n=h(n,r,o,s,e[t+1],21,-2054922799),s=h(s,n,r,o,e[t+8],6,1873313359),o=h(o,s,n,r,e[t+15],10,-30611744),r=h(r,o,s,n,e[t+6],15,-1560198380),n=h(n,r,o,s,e[t+13],21,1309151649),s=h(s,n,r,o,e[t+4],6,-145523070),o=h(o,s,n,r,e[t+11],10,-1120210379),r=h(r,o,s,n,e[t+2],15,718787259),n=h(n,r,o,s,e[t+9],21,-343485551),s=a(s,c),n=a(n,f),r=a(r,l),o=a(o,p)}return[s,n,r,o]}function l(e){let t="";const s=32*e.length;for(let n=0;n<s;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}function p(e){const t=[],s=e.length>>2;for(let e=0;e<s;e+=1)t[e]=0;const n=8*e.length;for(let s=0;s<n;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<s%32;return t}function g(e){const t="0123456789abcdef";let s="";for(let n=0;n<e.length;n+=1){const r=e.charCodeAt(n);s+=t.charAt(r>>>4&15)+t.charAt(15&r)}return s}function b(e){return unescape(encodeURIComponent(e))}function w(e){return function(e){return l(f(p(e),8*e.length))}(b(e))}function y(e,t){return function(e,t){let s=p(e);const n=[],r=[];s.length>16&&(s=f(s,8*e.length));for(let e=0;e<16;e+=1)n[e]=909522486^s[e],r[e]=1549556828^s[e];const o=f(n.concat(p(t)),512+8*t.length);return l(f(r.concat(o),640))}(b(e),b(t))}function x(e,t,s){return t?s?y(t,e):g(y(t,e)):s?w(e):g(w(e))}const m=3072;e.BareClient=class extends o{ws;http;meta(){return{}}constructor(e){super(3,e),this.ws=new URL(this.base),this.http=new URL(this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}ready=!0;async init(){this.ready=!0}connect(e,t,r,o,a,c,i,d){const u=new s(this.ws),h=()=>{u.removeEventListener("close",f),u.removeEventListener("message",l)},f=()=>{h()},l=e=>{if(h(),"string"!=typeof e.data)throw new TypeError("the first websocket message was not a text frame");const t=JSON.parse(e.data);if("open"!==t.type)throw new TypeError("message was not of open type");a(t.protocol),u.addEventListener("message",(e=>{c(e.data)}))};return u.addEventListener("close",f),u.addEventListener("message",l),u.addEventListener("open",(t=>{n.prototype.send.call(u,JSON.stringify({type:"connect",remote:e.toString(),protocols:r,headers:o,forwardHeaders:[]}))}),{once:!0}),u.send.bind(u)}async request(e,s,n,r,o){const a={credentials:"omit",method:s,signal:o};void 0!==n&&(a.body=n),a.headers=this.createBareHeaders(e,r);const c=await t(this.http+"?cache="+x(e.toString()),a),i=await this.readBareResponse(c);return{body:c.body,headers:i.headers,status:i.status,statusText:i.statusText}}async readBareResponse(e){if(!e.ok)throw new r(e.status,await e.json());const t=function(e){const t=new Headers(e),s="x-bare-headers";if(e.has(`${s}-0`)){const n=[];for(const[o,a]of e)if(o.startsWith(s)){if(!a.startsWith(";"))throw new r(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${o}`,message:"Value didn't begin with semi-colon."});n[parseInt(o.slice(15))]=a.slice(1),t.delete(o)}t.set(s,n.join(""))}return t}(e.headers),s={},n=t.get("x-bare-status");null!==n&&(s.status=parseInt(n));const o=t.get("x-bare-status-text");null!==o&&(s.statusText=o);const a=t.get("x-bare-headers");return null!==a&&(s.headers=JSON.parse(a)),s}createBareHeaders(e,t,s=[],n=[],r=[]){const o=new Headers;o.set("x-bare-url",e.toString()),o.set("x-bare-headers",JSON.stringify(t));for(const e of s)o.append("x-bare-forward-headers",e);for(const e of n)o.append("x-bare-pass-headers",e);for(const e of r)o.append("x-bare-pass-status",e.toString());return function(e){const t=new Headers(e);if(e.has("x-bare-headers")){const s=e.get("x-bare-headers");if(s.length>m){t.delete("x-bare-headers");let e=0;for(let n=0;n<s.length;n+=m){const r=s.slice(n,n+m),o=e++;t.set(`x-bare-headers-${o}`,`;${r}`)}}}}(o),o}}}));